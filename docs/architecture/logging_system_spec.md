# NetRaven Unified Logging System Specification

## Current Status (April 2025)
- The unified logging system is fully implemented and in production use.
- All backend log writing and API endpoints use the unified log table schema (see below).
- Legacy log models (`JobLog`, `ConnectionLog`) and fields (`user_id`, `job_type_id`) have been removed from the codebase and database.
- All log calls use the new logger interface with correct metadata.
- All tests (unit, integration, API) are updated and passing.
- Pydantic v2 migration and warning cleanup are planned as future enhancements, but do not affect current functionality.

## Overview
NetRaven's unified logging system provides a single, extensible, and high-performance log table in PostgreSQL to store all log events (job, connection, session, system, etc.) with rich metadata and robust filtering support. This system is designed for auditability, operational insight, and future extensibility.

---

## 1. Objectives
- Store all log events in a single, normalized table.
- Support filtering by job, device, type, level, time, and source.
- Enable efficient querying and future partitioning.
- Provide a clear API for log retrieval and statistics.
- Ensure schema and API are always in sync and fully tested.

---

## 2. Log Table Schema

**Table:** `logs`

| Column      | Type                | Description                                      |
|-------------|---------------------|--------------------------------------------------|
| id          | SERIAL PRIMARY KEY  | Unique log entry ID                              |
| timestamp   | TIMESTAMPTZ        | Log event time (UTC, indexed)                    |
| log_type    | VARCHAR(32)        | Log type: 'job', 'connection', 'session', etc.   |
| level       | VARCHAR(16)        | Log level: 'info', 'warning', 'error', 'debug'   |
| job_id      | INTEGER (nullable) | FK to jobs.id (optional, indexed)                |
| device_id   | INTEGER (nullable) | FK to devices.id (optional, indexed)             |
| source      | VARCHAR(64)        | Module/service name (e.g., 'worker.executor')    |
| message     | TEXT               | Log message                                      |
| meta        | JSONB (nullable)   | Arbitrary extra fields (structured metadata)      |

**Indexes:**
- `idx_logs_job_id` on `job_id`
- `idx_logs_device_id` on `device_id`
- `idx_logs_log_type` on `log_type`
- `idx_logs_level` on `level`
- `idx_logs_timestamp` on `timestamp`

**Notes:**
- No `user_id` or `job_type_id` fields in the current schema.
- Designed for future partitioning by date or log_type if needed.

---

## 3. API Endpoints (Built)

- `GET /logs/` — List logs with filters (job_id, device_id, log_type, level, source, time range, pagination)
- `GET /logs/{log_id}` — Retrieve a single log entry by ID
- `GET /logs/types` — List available log types
- `GET /logs/levels` — List available log levels
- `GET /logs/stats` — Get log statistics (total, by type, by level, last log time)

**Filtering Parameters:**
- `job_id`, `device_id`, `log_type`, `level`, `source`, `start_time`, `end_time`, `page`, `size`

---

## 4. Implementation Details
- **SQLAlchemy model** and **Alembic migration** are in sync with the above schema.
- All log writing in the backend uses this unified table.
- All log API endpoints are fully tested (see `tests/api/test_logs.py`).
- Test data and fixtures ensure referential integrity (jobs/devices created as needed).
- All datetime handling is timezone-aware and ISO 8601 compliant.
- Query parameters for datetimes are always URL-encoded using the `params` argument.
- FastAPI route ordering ensures `/logs/types`, `/logs/levels`, and `/logs/stats` are always accessible.

---

## 5. Best Practices & Lessons Learned
- Always use the `params` argument for query parameters in test clients to avoid encoding issues with special characters (e.g., `+` in datetimes).
- Ensure test data integrity by creating referenced objects (jobs/devices) or using `None` for nullable FKs.
- Keep model, migration, and API schemas in sync to avoid runtime errors and test failures.
- Use timezone-aware datetimes throughout the stack.
- Document all schema and API changes in the dev log and update tests accordingly.

---

## 6. Future Enhancements
- Add support for log partitioning by date or type for large-scale deployments.
- Integrate real-time log streaming (e.g., via Redis Pub/Sub and WebSockets).
- Add log retention and purge system jobs.
- Expand `meta` usage for richer structured logging.
- Address Pydantic deprecation warnings and migrate to Pydantic v2+ as needed.

---

## 7. References
- See `/alembic/versions/` for migration scripts.
- See `/netraven/db/models/log.py` for SQLAlchemy model.
- See `/tests/api/test_logs.py` for API test coverage.
- See `/docs/development_log/` for dev log and implementation notes.

---

*Document generated by Nova (AI assistant) — 2025-04-25* 